<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Limitador de Multi-Client TFS - Conformidade OTServList</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 900px;
            margin: 40px auto;
            padding: 20px;
            line-height: 1.6;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #2c3e50;
            border-bottom: 3px solid #3498db;
            padding-bottom: 10px;
        }
        h2 {
            color: #34495e;
            margin-top: 30px;
        }
        .warning {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px;
            margin: 20px 0;
        }
        .info {
            background: #d1ecf1;
            border-left: 4px solid #17a2b8;
            padding: 15px;
            margin: 20px 0;
        }
        .success {
            background: #e8f5e9;
            border-left: 4px solid #4caf50;
            padding: 15px;
            margin: 15px 0;
        }
        code {
            background: #f4f4f4;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
        }
        pre {
            background: #2d2d2d;
            color: #f8f8f2;
            padding: 20px;
            border-radius: 5px;
            overflow-x: auto;
            line-height: 1.4;
        }
        .step {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 15px;
            margin: 15px 0;
        }
        ul {
            margin: 10px 0;
        }
        li {
            margin: 8px 0;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
        }
        th {
            background: #3498db;
            color: white;
        }
        tr:nth-child(even) {
            background: #f2f2f2;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéÆ Implementa√ß√£o do Limitador de Multi-Client TFS</h1>
        <p><strong>Guia de Conformidade com OTServList.org</strong></p>

        <div class="warning">
            <strong>‚ö†Ô∏è Mudan√ßa Importante de Regra (5 de Dezembro de 2016)</strong><br>
            O OTServList.org agora exige um m√°ximo de <strong>4 multi-clients por IP</strong> para serem contados como jogadores reais. Servidores que violarem esta regra podem enfrentar penalidades ou remo√ß√£o da listagem.
        </div>

        <h2>üìã Vis√£o Geral</h2>
        <p>Esta implementa√ß√£o modifica o arquivo <code>protocolstatus.cpp</code> no TFS 1.0/1.1/1.2 para reportar corretamente a contagem de jogadores enquanto limita a contagem de multi-clients do mesmo endere√ßo IP.</p>

        <div class="info">
            <strong>Defini√ß√µes Importantes:</strong>
            <ul>
                <li><strong>Multi-client:</strong> M√∫ltiplos personagens logados de um √∫nico endere√ßo IP</li>
                <li><strong>Jogadores reais:</strong> O n√∫mero retornado ao OTServList via protocolo de status</li>
                <li><strong>Limite:</strong> M√°ximo de 4 conex√µes por IP contadas como jogadores reais</li>
            </ul>
        </div>

        <h2>üîß Implementa√ß√£o para TFS 1.0/1.1/1.2</h2>
        
        <div class="step">
            <strong>Passo 1:</strong> Localize o arquivo<br>
            Abra <code>src/protocolstatus.cpp</code> no diret√≥rio fonte do seu TFS.
        </div>

        <div class="step">
            <strong>Passo 2:</strong> Encontre o c√≥digo original<br>
            Procure por esta linha:
        </div>

        <pre>players.append_attribute("online") = std::to_string(g_game.getPlayersOnline()).c_str();</pre>

        <div class="step">
            <strong>Passo 3:</strong> Substitua pela nova implementa√ß√£o
        </div>

        <pre>uint32_t real = 0;

std::map&lt;uint32_t, uint32_t&gt; listIP;

for (const auto& it : g_game.getPlayers()) {
    if (it.second->getIP() != 0) {
        auto ip = listIP.find(it.second->getIP());
        if (ip != listIP.end()) {
            listIP[it.second->getIP()]++;
            if (listIP[it.second->getIP()] &lt; 5) {
                real++;
            }
        } else {
            listIP[it.second->getIP()] = 1;
            real++;
        }
    }
}
players.append_attribute("online") = std::to_string(real).c_str();</pre>

        <div class="step">
            <strong>Passo 4:</strong> Recompile seu servidor<br>
            Ap√≥s fazer as altera√ß√µes, recompile o TFS e reinicie seu servidor.
        </div>

        <h2>üí° Como Funciona</h2>
        <ol>
            <li><strong>Rastreamento de IP:</strong> Cria um mapa para armazenar contagem de conex√µes por endere√ßo IP</li>
            <li><strong>Itera√ß√£o de Jogadores:</strong> Percorre todos os jogadores online</li>
            <li><strong>Verifica√ß√£o de IP:</strong> Verifica se o jogador tem IP v√°lido (diferente de 0)</li>
            <li><strong>L√≥gica do Contador:</strong>
                <ul>
                    <li>Se o IP existe: incrementa o contador para aquele IP</li>
                    <li>S√≥ conta se conex√µes &lt; 5 (ou seja, 4 ou menos)</li>
                    <li>Se IP novo: adiciona ao mapa com contagem 1</li>
                </ul>
            </li>
            <li><strong>Relat√≥rio:</strong> Retorna contagem ajustada ao protocolo de status</li>
        </ol>

        <h2>üìä Exemplo Pr√°tico</h2>
        <table>
            <tr>
                <th>IP</th>
                <th>Personagens Logados</th>
                <th>Contados como Real</th>
            </tr>
            <tr>
                <td>192.168.1.10</td>
                <td>3</td>
                <td>3</td>
            </tr>
            <tr>
                <td>192.168.1.20</td>
                <td>4</td>
                <td>4</td>
            </tr>
            <tr>
                <td>192.168.1.30</td>
                <td>8</td>
                <td>4 (limitado)</td>
            </tr>
            <tr>
                <td>192.168.1.40</td>
                <td>2</td>
                <td>2</td>
            </tr>
            <tr>
                <td><strong>TOTAL</strong></td>
                <td><strong>17 personagens</strong></td>
                <td><strong>13 jogadores reais</strong></td>
            </tr>
        </table>

        <h2>üõ°Ô∏è Alternativa: Solu√ß√£o com IPTables</h2>
        <p>Voc√™ tamb√©m pode for√ßar um limite global de 4 conex√µes usando iptables:</p>
        <pre>iptables -A INPUT -p tcp --dport 7172 -m connlimit --connlimit-above 4 -j DROP</pre>
        <p><em>Substitua 7172 pela sua porta do jogo real</em></p>

        <div class="warning">
            <strong>Nota:</strong> IPTables bloqueia conex√µes no n√≠vel de rede, enquanto a solu√ß√£o em c√≥digo apenas afeta a contagem. Escolha baseado na pol√≠tica de multi-client do seu servidor.
        </div>

        <h2>üìå Por Que Esta Mudan√ßa?</h2>
        <p>O OTServList descobriu servidores onde <strong>10 pessoas reais controlavam 250 personagens</strong>, criando propaganda enganosa. Esta regra garante:</p>
        <ul>
            <li>Representa√ß√£o precisa da contagem de jogadores</li>
            <li>Competi√ß√£o justa entre servidores</li>
            <li>Melhor experi√™ncia para jogadores em potencial navegando nas listas de servidores</li>
        </ul>

        <h2>üî® Implementa√ß√£o para TFS 8.6 (0.3.6)</h2>
        <div class="info">
            <strong>Para usu√°rios do TFS 8.6:</strong> A implementa√ß√£o requer adapta√ß√£o j√° que o TFS 0.3.6 usa estrutura de c√≥digo diferente. Procure pela l√≥gica similar de contagem de jogadores nos seus arquivos protocolstatus e aplique a mesma metodologia de rastreamento de IP com sintaxe C++ compat√≠vel com sua vers√£o.
        </div>

        <div class="success">
            <strong>üí° Dica para TFS 8.6:</strong><br>
            O TFS 0.3.6 pode n√£o suportar features do C++11 como <code>auto</code>. Voc√™ precisar√° declarar tipos explicitamente:
            <pre style="background: #2d2d2d; color: #f8f8f2; padding: 10px; margin-top: 10px;">std::map&lt;uint32_t, uint32_t&gt;::iterator ip = listIP.find(it.second->getIP());</pre>
        </div>

        <h2>üêõ Troubleshooting</h2>
        <div class="step">
            <strong>Erro de Compila√ß√£o?</strong>
            <ul>
                <li>Verifique se voc√™ tem suporte a C++11 habilitado</li>
                <li>Certifique-se de que <code>&lt;map&gt;</code> est√° inclu√≠do no arquivo</li>
                <li>Limpe o build anterior antes de recompilar</li>
            </ul>
        </div>

        <div class="step">
            <strong>Contagem Incorreta?</strong>
            <ul>
                <li>Verifique se o servidor foi recompilado e reiniciado</li>
                <li>Teste com m√∫ltiplas contas do mesmo IP</li>
                <li>Confirme que o c√≥digo est√° no lugar correto do protocolstatus.cpp</li>
            </ul>
        </div>

        <h2>üìö Recursos Adicionais</h2>
        <ul>
            <li><strong>Thread Original:</strong> Discuss√£o no F√≥rum OTLand</li>
            <li><strong>Contato:</strong> <a href="http://otservlist.org/contact">http://otservlist.org/contact</a></li>
            <li><strong>Refer√™ncia do C√≥digo:</strong> Postado por Gunz no OTLand</li>
            <li><strong>TFS GitHub:</strong> <a href="https://github.com/otland/forgottenserver">https://github.com/otland/forgottenserver</a></li>
        </ul>

        <div class="warning">
            <strong>‚ö†Ô∏è Prazo de Conformidade:</strong> Esta regra est√° sendo aplicada desde 5 de dezembro de 2016. Certifique-se de que seu servidor esteja em conformidade para manter a elegibilidade na listagem.
        </div>

        <h2>‚úÖ Checklist de Implementa√ß√£o</h2>
        <div class="success">
            <ul style="list-style: none; padding-left: 0;">
                <li>‚òê Backup do arquivo protocolstatus.cpp original</li>
                <li>‚òê C√≥digo modificado corretamente</li>
                <li>‚òê Servidor recompilado sem erros</li>
                <li>‚òê Teste realizado com m√∫ltiplos multi-clients</li>
                <li>‚òê Contagem verificada no OTServList</li>
                <li>‚òê Documenta√ß√£o atualizada para sua equipe</li>
            </ul>
        </div>

        <hr style="margin: 30px 0;">
        <p style="text-align: center; color: #7f8c8d;">
            <em>Desenvolvido pela comunidade OTLand ‚Ä¢ Implementa√ß√£o por Gunz</em>
        </p>
    </div>
</body>
</html>
